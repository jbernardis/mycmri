<!DOCTYPE html>
<html>
<head>
<style>
#pq {
	font-size: 25px;
	font-family: 'Arial';
	background-color: cyan;
}
p {
	font-size: 20px;
}
li {
	font-size: 22px;
	color: blue;
}
</style>
</head>
<body>
<h1>NODE Server HTTP API</h1>
<h2>Node</h2>

<p id="pq">http://IP:PORT?cmd="init"&addr="node-address"</p>
<p>Initializes the specified node.</p>

<p id="pq">http://IP:PORT?cmd="refresh"&addr="node-address"</p>
<p>Causes the node to resend all of its status reports</p>

<p id="pq">http://IP:PORT?cmd="setconfig"&addr="node-address"&naddr="new-node-address"&inputs="ninputs"&outputs="noutputs"&servos="nservos"</p>
<p>This command is used to change the addess of a node as well as the number of circuits of each type that it has.  ninputs is the number of input circuits, not input bits.  Each input circuit supports 8 input bits.
The same for outputs and servos; each output circuit supports 8 output bits, and each servo circuit supports 16 servos</p>
<p>NOTE:  Once this command i run, accessing that node will not be possible.  Everything will need to be reinitialized, and any node configuration files will need to be updated to reflect the new configuration.</p>

<p id="pq">http://IP:PORT?cmd="store"&addr="node-address"</p>
<p>forces the node to store its current configuration into non-volatile memory</p>

<p id="pq">http://IP:PORT?cmd="noderpt"</p>
<p>identifies the nodes that have responded.</p>
<p>This report is a JSON string with the following format:</p>
<pre><code>
{
	node: {
		'addr': node-address, 
		'input': number-of-input-circuits, 
		'output': number-of-output-circuits',
		'servo': number-of-servo-circuits, 
		'flags': number-of-flags, 
		'registers': number-of-flags, 
		'active': has-the-node-responded
	},
	...
}
</code></pre>
<p>The "active" value is a boolean value that indicates if a configured node has responded yet.</p> 

<p id="pq">http://IP:PORT?cmd="quit"</p>
<p>shuts down the node server</p>


<h2>Turnouts</h2>
<p>These commands refer to turnouts and servos.  These two items share the same index-space.  The difference is that turnouts have pre-defined angles for normal, reverse, and initial positions;  servos can be set to any arbitrary angle.</p>
<p id="pq">http://IP:PORT?cmd="normal"&addr="node-address"&index="turnout-index"</p>
<p>Sets the indicated turnout to NORMAL position</p>

<p id="pq">http://IP:PORT?cmd="reverse"&addr="node-address"&index="turnout-index"</p>
<p>Sets the indicated turnout to REVERSE position</p>

<p id="pq">http://IP:PORT?cmd="toggle"&addr="node-address"&index="turnout-index"</p>
<p>Changes the position of the indicated turnout, NORMAL -> REVERSE, or REVERSE -> NORMAL.</p>

<p id="pq">http://IP:PORT?cmd="angle"&addr="node-address"&index="servo-index"&angle="angle"</p>
<p>Sets the position of the indicated servo to the specified angle</p>

<p id="pq">http://IP:PORT?cmd="setlimits"&addr="node-address"&index="turnout-index"&normal="normal-angle"&reverse="reverse-angle"&initial="initial-angle"</p>
<p>Sets the three pre-defined positions for the indicated turnout.  If initial is not proveded, the normal value will be used.</p>

<h2>Outputs</h2>
<p>These commands refer to the node outputs.  These are either on or off.</p>

<p id="pq">http://IP:PORT?cmd="outon"&addr="node-address"&index="output-index"</p>
<p>Turns the indicated output on</p>

<p id="pq">http://IP:PORT?cmd="outoff"&addr="node-address"&index="output-index"</p>
<p>Turns the indicated output off</p>

<h2>Server Internal Objects</h2>
<p>The node server has two objects that have no physical manifestation.  Flags are boolean objects that can be set, cleared, and tested.  Registers are simply variables.  They can be set to, and tested for, any arbitrary string value.</p>
<h3>Flags</h3>

<p id="pq">http://IP:PORT?cmd="setflag"&addr="node-address"&index="flag-index"</p>
<p>Turns the indicated flag to True</p>

<p id="pq">http://IP:PORT?cmd="clearflag"&addr="node-address"&index="flag-index"</p>
<p>Turns the indicated flag to False</p>


<h3>Registers</h3>

<p id="pq">http://IP:PORT?cmd="setregister"&addr="node-address"&index="register-index"&value="value"</p>
<p>Sets the indicated register to value</p>

<h2>Reports</h2>
These commands all generate reports, sent as JSON strings, indicating the current status of the specified node.

<p id="pq">http://IP:PORT?cmd="inputs"&addr="node-address"</p>
<p>Resulting report:</p>
<pre><code>
[True, False, .....]
</code></pre>
<p>Where there will be one boolean flag for each input bit.  Inputs are pulled high, so they will report True normally, and False when "pressed"</p>

<p id="pq">http://IP:PORT?cmd="outputs"&addr="node-address"</p>
<p>Resulting report:</p>
<pre><code>
[True, False, .....]
</code></pre>
<p>Where there will be one boolean flag for each output bit.</p>

<p id="pq">http://IP:PORT?cmd="turnouts"&addr="node-address"</p>
<p>Resulting report:</p>
<pre><code>
[
	[normal-value, reverse-value, initial-value, current-value],
	...
]
</code></pre>
<p>Where there will be one line, containing the above 4 values, for each servo.  For those servos not being used as turnouts, only the current-value will have meaning</p>

<p id="pq">http://IP:PORT?cmd="flags"&addr="node-address"</p>
<p>Resulting report:</p>
<pre><code>
[True, False, .....]
</code></pre>
<p>Where there will be one boolean flag for each flag.</p>

<p id="pq">http://IP:PORT?cmd="registers"&addr="node-address"</p>
<p>Resulting report:</p>
<pre><code>
[value, value, .....]
</code></pre>
<p>Where there will be one value for each register.</p>

<p id="pq">http://IP:PORT?cmd="getconfig"&addr="node-address"</p>
<p>Resulting report:</p>
<pre><code>
{
	'name': node-name, 
	'input': number-of-input-circuits, 
	'output': number-of-output-circuits',
	'servo': number-of-servo-circuits, 
	'flags': number-of-flags, 
	'registers': number-of-flags
}
</code></pre>

<h1>Subscribing to the node server</h1>
<p>Any client program has the ability to subscribe to the node server to receive notifications whenever there are any changes to the node status.
These notifications are sent in the form of JSON-encoded reports.  There are 5 such reports, each of which is described below.</p>
<ul>
<li>Inputs</li>
<p>Any time any of the inputs for a node changes, an inputs report is sent as follows.</p>
<pre><code>
{
	"type": "input",
	"addr": addr,
	"values": vals,
	"delta": delta
}
</code></pre>
<p>The delta field is a boolean indicating if this is a full report (False) or a delta report (True).   The format of the values field will be different for each of these. </p>

<p>If delta is True, values is a two dimensional array of <index, value> pairs, and only the changed inputs will be present:</p>
<pre><code>
[
	[3, True],
	[7, False],
	...
]
</code></pre>

<p>Whereas if delta is False, values will simply be an array of every input value:</p>
<pre><code>
[True, False, ...]
</code></pre>


<li>Outputs</li>
Any time any of the outputs change, an outputs report will be sent as follows.</p>
<pre><code>
{
	"type": "output",
	"addr": addr,
	"values": [ True, False, ... ]
}
</code></pre>
<p>There will be a value in the values array for every output.</p>
						
<li>Turnouts/Servos</li>
Any time any of the servos or turnouts change, a turnouts report will be sent as follows.</p>
<pre><code>
{
	"type": "turnout",
	"addr": addr,
	"values": [
		[ normal, reverse, initial, current ],
		...
	]
}
</code></pre>
			
<li>Registers</li>
Any time any of the register change, a registers report will be sent as follows.</p>
<pre><code>
{
	"type": "registers",
	"addr": addr,
	"values": [ value, value, ... ]
}
</code></pre>
<p>There will be a value in the values array for every register.</p>

<li>Flags</li>
Any time any of the flags change, a flags report will be sent as follows.</p>
<pre><code>
{
	"type": "flags",
	"addr": addr,
	"values": [ True, False, ... ]
}
</code></pre>
<p>There will be a value in the values array for every flag.</p>
			
</ul>
			

</body>